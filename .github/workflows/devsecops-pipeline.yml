name: DevSecOps Security Pipeline
on: [push, pull_request]
jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      
      - name: Run SAST Scan
        run: |
          docker run --rm -v "$(pwd):/src" returntocorp/semgrep semgrep scan --config auto
      
      - name: Build Docker Image
        run: docker build -t app:${{ github.sha }} -f docker/Dockerfile .
      
      - name: Scan Container Image
        run: |
          trivy image app:${{ github.sha }} \
            --format sarif \
            --output trivy-results.sarif \
            --exit-code 1 \
            --severity HIGH,CRITICAL
      
      - name: Validate Kubernetes Manifests
        run: kubectl apply --dry-run=client -f k8s/
      
      - name: Terraform Security Scan
        run: |
          docker run --rm -v "$(pwd)/terraform:/tf" bridgecrew/checkov -d /tf
